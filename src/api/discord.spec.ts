import { hasPermissions } from "./discord";

describe("discord", () => {
  describe("hasPermissions", () => {
    const adminRole = "1023337302858145936";
    const somePermissionsRole = "1023344408466300989";
    const member = {
      avatar: null,
      communication_disabled_until: null,
      flags: 0,
      is_pending: false,
      joined_at: "2018-08-02T03:13:11.453000+00:00",
      nick: null,
      pending: false,
      premium_since: null,
      roles: [],
      user: {
        id: "91403530358775808",
        username: "Crasken",
        avatar: "118670c2636c3ca9a045ad49a2b7d926",
        avatar_decoration: null,
        discriminator: "2675",
        public_flags: 0,
      },
      mute: false,
      deaf: false,
    };
    const guild = {
      id: "229093679103606785",
      name: "Tendies Esports Club",
      icon: "938350ebcc3dc7e4ee1945a15ed6e3da",
      description: null,
      splash: null,
      discovery_splash: null,
      features: [],
      emojis: [
        {
          name: "GodEmperor",
          roles: [],
          id: "245736321518141441",
          require_colons: true,
          managed: false,
          animated: false,
          available: true,
        },
        {
          name: "BabyRage",
          roles: [],
          id: "245736648812396555",
          require_colons: true,
          managed: false,
          animated: false,
          available: true,
        },
        {
          name: "VokerGasm",
          roles: [],
          id: "245736737635172352",
          require_colons: true,
          managed: false,
          animated: false,
          available: true,
        },
        {
          name: "PPD",
          roles: [],
          id: "245736877397770240",
          require_colons: true,
          managed: false,
          animated: false,
          available: true,
        },
        {
          name: "GabeN",
          roles: [],
          id: "245737396849737738",
          require_colons: true,
          managed: false,
          animated: false,
          available: true,
        },
        {
          name: "NAPride",
          roles: [],
          id: "245737487098576896",
          require_colons: true,
          managed: false,
          animated: false,
          available: true,
        },
        {
          name: "DandiFace",
          roles: [],
          id: "245737652446429204",
          require_colons: true,
          managed: false,
          animated: false,
          available: true,
        },
        {
          name: "lel",
          roles: [],
          id: "255523418311622666",
          require_colons: true,
          managed: false,
          animated: false,
          available: true,
        },
        {
          name: "Vohiyo",
          roles: [],
          id: "334087746106949645",
          require_colons: true,
          managed: false,
          animated: false,
          available: true,
        },
        {
          name: "BibleThump",
          roles: [],
          id: "334089160883175424",
          require_colons: true,
          managed: false,
          animated: false,
          available: true,
        },
        {
          name: "MonkaS",
          roles: [],
          id: "334089304131239936",
          require_colons: true,
          managed: false,
          animated: false,
          available: true,
        },
        {
          name: "4Head",
          roles: [],
          id: "334089476701945857",
          require_colons: true,
          managed: false,
          animated: false,
          available: true,
        },
        {
          name: "WutFace",
          roles: [],
          id: "334089919523717130",
          require_colons: true,
          managed: false,
          animated: false,
          available: true,
        },
        {
          name: "PPDSalt",
          roles: [],
          id: "334090380112822273",
          require_colons: true,
          managed: false,
          animated: false,
          available: true,
        },
        {
          name: "MingLee",
          roles: [],
          id: "334092636845768704",
          require_colons: true,
          managed: false,
          animated: false,
          available: true,
        },
        {
          name: "Kappa",
          roles: [],
          id: "334092722531074058",
          require_colons: true,
          managed: false,
          animated: false,
          available: true,
        },
        {
          name: "KappaRoss",
          roles: [],
          id: "334092765338140674",
          require_colons: true,
          managed: false,
          animated: false,
          available: true,
        },
        {
          name: "TriHard",
          roles: [],
          id: "334093593188761602",
          require_colons: true,
          managed: false,
          animated: false,
          available: true,
        },
        {
          name: "PogChamp",
          roles: [],
          id: "334093614168932363",
          require_colons: true,
          managed: false,
          animated: false,
          available: true,
        },
        {
          name: "SeemsGood",
          roles: [],
          id: "334093614986821632",
          require_colons: true,
          managed: false,
          animated: false,
          available: true,
        },
        {
          name: "Keepo",
          roles: [],
          id: "334093621752233987",
          require_colons: true,
          managed: false,
          animated: false,
          available: true,
        },
        {
          name: "EleGiggle",
          roles: [],
          id: "334093754757545994",
          require_colons: true,
          managed: false,
          animated: false,
          available: true,
        },
        {
          name: "Thinking",
          roles: [],
          id: "382346884234215437",
          require_colons: true,
          managed: false,
          animated: false,
          available: true,
        },
        {
          name: "Discord_logo1600",
          roles: [],
          id: "384093978796097536",
          require_colons: true,
          managed: false,
          animated: false,
          available: true,
        },
        {
          name: "grubby",
          roles: [],
          id: "418874843598028820",
          require_colons: true,
          managed: false,
          animated: false,
          available: true,
        },
        {
          name: "dab",
          roles: [],
          id: "428613601654472705",
          require_colons: true,
          managed: false,
          animated: false,
          available: true,
        },
        {
          name: "__",
          roles: [],
          id: "507384965978128396",
          require_colons: true,
          managed: false,
          animated: false,
          available: true,
        },
        {
          name: "howcute",
          roles: [],
          id: "633837971392692234",
          require_colons: true,
          managed: false,
          animated: false,
          available: true,
        },
        {
          name: "3x",
          roles: [],
          id: "813271516191653898",
          require_colons: true,
          managed: false,
          animated: true,
          available: true,
        },
        {
          name: "fish",
          roles: [],
          id: "813272041196748800",
          require_colons: true,
          managed: false,
          animated: false,
          available: true,
        },
        {
          name: "pauseChamp",
          roles: [],
          id: "819042759284752384",
          require_colons: true,
          managed: false,
          animated: false,
          available: true,
        },
        {
          name: "PauseFish",
          roles: [],
          id: "822329655562076170",
          require_colons: true,
          managed: false,
          animated: false,
          available: true,
        },
        {
          name: "Sadge",
          roles: [],
          id: "823055221558738964",
          require_colons: true,
          managed: false,
          animated: false,
          available: true,
        },
        {
          name: "Madge",
          roles: [],
          id: "823055278659862559",
          require_colons: true,
          managed: false,
          animated: false,
          available: true,
        },
        {
          name: "Boomer",
          roles: [],
          id: "828508816073031731",
          require_colons: true,
          managed: false,
          animated: false,
          available: true,
        },
        {
          name: "Zoomer",
          roles: [],
          id: "830324087527571496",
          require_colons: true,
          managed: false,
          animated: false,
          available: true,
        },
        {
          name: "SoyChamp",
          roles: [],
          id: "830326376795602944",
          require_colons: true,
          managed: false,
          animated: false,
          available: true,
        },
        {
          name: "Cope",
          roles: [],
          id: "830506014696407101",
          require_colons: true,
          managed: false,
          animated: false,
          available: true,
        },
        {
          name: "OmegaLuL",
          roles: [],
          id: "838300304973627412",
          require_colons: true,
          managed: false,
          animated: false,
          available: true,
        },
        {
          name: "bonk",
          roles: [],
          id: "889713562531008562",
          require_colons: true,
          managed: false,
          animated: false,
          available: true,
        },
        {
          name: "bonk2",
          roles: [],
          id: "889714027817750568",
          require_colons: true,
          managed: false,
          animated: false,
          available: true,
        },
        {
          name: "ree",
          roles: [],
          id: "913269252851630080",
          require_colons: true,
          managed: false,
          animated: false,
          available: true,
        },
        {
          name: "bingchilling",
          roles: [],
          id: "918324685786210307",
          require_colons: true,
          managed: false,
          animated: false,
          available: true,
        },
      ],
      stickers: [],
      banner: null,
      owner_id: "123159927244980224",
      application_id: null,
      region: "us-east",
      afk_channel_id: null,
      afk_timeout: 300,
      system_channel_id: null,
      widget_enabled: false,
      widget_channel_id: null,
      verification_level: 0,
      roles: [
        {
          id: "229093679103606785",
          name: "@everyone",
          permissions: "1071698665025",
          position: 0,
          color: 0,
          hoist: false,
          managed: false,
          mentionable: false,
          icon: null,
          unicode_emoji: null,
          flags: 0,
        },
        {
          id: "241309284531568640",
          name: "Filthy League Peasant",
          permissions: "0",
          position: 17,
          color: 14372994,
          hoist: false,
          managed: false,
          mentionable: false,
          icon: null,
          unicode_emoji: null,
          flags: 0,
        },
        {
          id: "259547852332728321",
          name: "DJ",
          permissions: "6546775617",
          position: 16,
          color: 420607,
          hoist: false,
          managed: false,
          mentionable: false,
          icon: null,
          unicode_emoji: null,
          flags: 0,
        },
        {
          id: "259547991025778690",
          name: "Dank Bot",
          permissions: "6546775617",
          position: 15,
          color: 9936031,
          hoist: false,
          managed: false,
          mentionable: false,
          icon: null,
          unicode_emoji: null,
          flags: 0,
        },
        {
          id: "312710961070866432",
          name: "Admins",
          permissions: "4026007247",
          position: 14,
          color: 2123412,
          hoist: true,
          managed: false,
          mentionable: true,
          icon: null,
          unicode_emoji: null,
          flags: 0,
        },
        {
          id: "330535544402477056",
          name: "Rythm",
          permissions: "3457088",
          position: 13,
          color: 0,
          hoist: false,
          managed: true,
          mentionable: false,
          icon: null,
          unicode_emoji: null,
          flags: 0,
          tags: {
            bot_id: "235088799074484224",
          },
        },
        {
          id: "341786383721168909",
          name: "Anti-Social NEET",
          permissions: "6546775617",
          position: 12,
          color: 6323595,
          hoist: true,
          managed: false,
          mentionable: false,
          icon: null,
          unicode_emoji: null,
          flags: 0,
        },
        {
          id: "381289428158513163",
          name: "Rythm 2",
          permissions: "6442713672",
          position: 11,
          color: 0,
          hoist: false,
          managed: true,
          mentionable: false,
          icon: null,
          unicode_emoji: null,
          flags: 0,
          tags: {
            bot_id: "252128902418268161",
          },
        },
        {
          id: "625730700179537951",
          name: "Dank Memer",
          permissions: "2905975878",
          position: 10,
          color: 0,
          hoist: false,
          managed: true,
          mentionable: false,
          icon: null,
          unicode_emoji: null,
          flags: 0,
          tags: {
            bot_id: "270904126974590976",
          },
        },
        {
          id: "630115776560627725",
          name: "OwOBot",
          permissions: "6445657088",
          position: 9,
          color: 0,
          hoist: false,
          managed: true,
          mentionable: false,
          icon: null,
          unicode_emoji: null,
          flags: 0,
          tags: {
            bot_id: "630111522302984192",
          },
        },
        {
          id: "630225571795959821",
          name: "LewdsBotDev",
          permissions: "6442470400",
          position: 8,
          color: 0,
          hoist: false,
          managed: true,
          mentionable: false,
          icon: null,
          unicode_emoji: null,
          flags: 0,
          tags: {
            bot_id: "630224177055399957",
          },
        },
        {
          id: "632764429137739784",
          name: "Nitro Booster",
          permissions: "0",
          position: 7,
          color: 16023551,
          hoist: false,
          managed: true,
          mentionable: false,
          icon: null,
          unicode_emoji: null,
          flags: 0,
          tags: {
            premium_subscriber: null,
          },
        },
        {
          id: "651113957372723245",
          name: "WordCloud",
          permissions: "6443576512",
          position: 6,
          color: 0,
          hoist: false,
          managed: true,
          mentionable: false,
          icon: null,
          unicode_emoji: null,
          flags: 0,
          tags: {
            bot_id: "651110308324179988",
          },
        },
        {
          id: "854542117838127115",
          name: "k-er",
          permissions: "109625990721",
          position: 5,
          color: 5159226,
          hoist: false,
          managed: false,
          mentionable: false,
          icon: null,
          unicode_emoji: null,
          flags: 0,
        },
        {
          id: "867965951121965177",
          name: "Rythm-chan",
          permissions: "3457088",
          position: 4,
          color: 0,
          hoist: false,
          managed: true,
          mentionable: false,
          icon: null,
          unicode_emoji: null,
          flags: 0,
          tags: {
            bot_id: "826622077615341569",
          },
        },
        {
          id: "996627940915814474",
          name: "Dota Gamer",
          permissions: "1071698665025",
          position: 3,
          color: 15844367,
          hoist: false,
          managed: false,
          mentionable: false,
          icon: null,
          unicode_emoji: null,
          flags: 0,
        },
        {
          id: "1023337302858145936",
          name: "Real Admin",
          permissions: "1071698665033",
          position: 2,
          color: 0,
          hoist: false,
          managed: false,
          mentionable: false,
          icon: null,
          unicode_emoji: null,
          flags: 0,
        },
        {
          id: "1023344408466300989",
          name: "test",
          permissions: "1071698665025",
          position: 1,
          color: 0,
          hoist: false,
          managed: false,
          mentionable: false,
          icon: null,
          unicode_emoji: null,
          flags: 0,
        },
      ],
      default_message_notifications: 1,
      mfa_level: 0,
      explicit_content_filter: 0,
      max_presences: null,
      max_members: 500000,
      max_stage_video_channel_users: 0,
      max_video_channel_users: 25,
      vanity_url_code: null,
      premium_tier: 0,
      premium_subscription_count: 0,
      system_channel_flags: 0,
      preferred_locale: "en-US",
      rules_channel_id: null,
      public_updates_channel_id: null,
      hub_type: null,
      premium_progress_bar_enabled: false,
      nsfw: false,
      nsfw_level: 0,
    };
    const channels = [
      {
        id: "229093679103606785",
        last_message_id: "1016481147091431537",
        type: 0,
        name: "general",
        position: 0,
        flags: 0,
        parent_id: null,
        topic: null,
        guild_id: "229093679103606785",
        permission_overwrites: [
          {
            id: "229093679103606785",
            type: 0,
            allow: "0",
            deny: "268435472",
          },
        ],
        last_pin_timestamp: "2018-08-02T03:12:09.615000+00:00",
        rate_limit_per_user: 0,
        nsfw: false,
      },
      {
        id: "229093679103606787",
        last_message_id: null,
        type: 2,
        name: "Tendies Esports Club",
        position: 2,
        flags: 0,
        parent_id: null,
        bitrate: 64000,
        user_limit: 6,
        rtc_region: null,
        guild_id: "229093679103606785",
        permission_overwrites: [
          {
            id: "229093679103606785",
            type: 0,
            allow: "0",
            deny: "871366673",
          },
          {
            id: "123159927244980224",
            type: 1,
            allow: "0",
            deny: "0",
          },
          {
            id: "996627940915814474",
            type: 0,
            allow: "549792566784",
            deny: "0",
          },
        ],
        rate_limit_per_user: 0,
        nsfw: false,
      },
      {
        id: "259542347472175105",
        last_message_id: "1023127587381334016",
        type: 0,
        name: "music_bot",
        position: 1,
        flags: 0,
        parent_id: null,
        topic: null,
        guild_id: "229093679103606785",
        permission_overwrites: [
          {
            id: "229093679103606785",
            type: 0,
            allow: "0",
            deny: "1024",
          },
          {
            id: "341786383721168909",
            type: 0,
            allow: "1024",
            deny: "0",
          },
        ],
        rate_limit_per_user: 0,
        nsfw: false,
      },
      {
        id: "263208278417211393",
        last_message_id: null,
        type: 2,
        name: "Robby",
        position: 0,
        flags: 0,
        parent_id: null,
        bitrate: 96000,
        user_limit: 0,
        rtc_region: null,
        guild_id: "229093679103606785",
        permission_overwrites: [],
        rate_limit_per_user: 0,
        nsfw: false,
      },
      {
        id: "333701466973798423",
        last_message_id: "1023265070978957322",
        type: 0,
        name: "things-to-do",
        position: 6,
        flags: 0,
        parent_id: null,
        topic: null,
        guild_id: "229093679103606785",
        permission_overwrites: [
          {
            id: "341786383721168909",
            type: 0,
            allow: "3072",
            deny: "0",
          },
          {
            id: "229093679103606785",
            type: 0,
            allow: "0",
            deny: "3072",
          },
        ],
        last_pin_timestamp: "2022-01-14T01:07:20+00:00",
        rate_limit_per_user: 0,
        nsfw: true,
      },
      {
        id: "341786229160804352",
        last_message_id: "1023266515937656852",
        type: 0,
        name: "computer_science_was_a_mistake__alan_turing",
        position: 2,
        flags: 0,
        parent_id: null,
        topic: null,
        guild_id: "229093679103606785",
        permission_overwrites: [
          {
            id: "229093679103606785",
            type: 0,
            allow: "0",
            deny: "805829713",
          },
          {
            id: "1023344408466300989",
            type: 0,
            allow: "1024",
            deny: "0",
          },
          {
            id: "341786383721168909",
            type: 0,
            allow: "515137",
            deny: "0",
          },
        ],
        last_pin_timestamp: "2021-03-03T04:38:28+00:00",
        rate_limit_per_user: 0,
        nsfw: false,
      },
      {
        id: "344137897575710721",
        last_message_id: "984617800188432384",
        type: 2,
        name: "k",
        position: 1,
        flags: 0,
        parent_id: null,
        bitrate: 64000,
        user_limit: 0,
        rtc_region: null,
        guild_id: "229093679103606785",
        permission_overwrites: [
          {
            id: "341786383721168909",
            type: 0,
            allow: "1048576",
            deny: "0",
          },
          {
            id: "854542117838127115",
            type: 0,
            allow: "1049600",
            deny: "0",
          },
          {
            id: "229093679103606785",
            type: 0,
            allow: "0",
            deny: "1048576",
          },
          {
            id: "259547991025778690",
            type: 0,
            allow: "3146752",
            deny: "0",
          },
        ],
        rate_limit_per_user: 0,
        nsfw: false,
      },
      {
        id: "404100623479603203",
        last_message_id: "1015474793841172531",
        type: 0,
        name: "robot-gf",
        position: 5,
        flags: 0,
        parent_id: null,
        topic: null,
        guild_id: "229093679103606785",
        permission_overwrites: [
          {
            id: "573764949474541568",
            type: 1,
            allow: "76800",
            deny: "0",
          },
          {
            id: "229093679103606785",
            type: 0,
            allow: "0",
            deny: "805828689",
          },
          {
            id: "630224177055399957",
            type: 1,
            allow: "1024",
            deny: "0",
          },
          {
            id: "341786383721168909",
            type: 0,
            allow: "805829713",
            deny: "0",
          },
        ],
        last_pin_timestamp: "2020-02-26T03:35:46.590000+00:00",
        rate_limit_per_user: 0,
        nsfw: true,
      },
      {
        id: "449626234805288960",
        last_message_id: "904889622780321802",
        type: 0,
        name: "tabletop-documents-and-info",
        position: 7,
        flags: 0,
        parent_id: null,
        topic: null,
        guild_id: "229093679103606785",
        permission_overwrites: [
          {
            id: "229093679103606785",
            type: 0,
            allow: "0",
            deny: "805829713",
          },
          {
            id: "341786383721168909",
            type: 0,
            allow: "805829713",
            deny: "0",
          },
        ],
        last_pin_timestamp: "2021-11-02T00:28:18+00:00",
        rate_limit_per_user: 0,
        nsfw: false,
      },
      {
        id: "604154675553632282",
        last_message_id: "1010431388400488498",
        type: 0,
        name: "wholesome-channel",
        position: 4,
        flags: 0,
        parent_id: null,
        topic: null,
        guild_id: "229093679103606785",
        permission_overwrites: [
          {
            id: "229093679103606785",
            type: 0,
            allow: "0",
            deny: "268435472",
          },
        ],
        last_pin_timestamp: "2021-11-27T04:05:12+00:00",
        rate_limit_per_user: 0,
        nsfw: false,
      },
      {
        id: "727382362954137640",
        last_message_id: "816529878170075147",
        type: 0,
        name: "book-club",
        position: 8,
        flags: 0,
        parent_id: null,
        topic: null,
        guild_id: "229093679103606785",
        permission_overwrites: [
          {
            id: "229093679103606785",
            type: 0,
            allow: "0",
            deny: "1024",
          },
        ],
        last_pin_timestamp: "2020-07-02T21:02:42.767000+00:00",
        rate_limit_per_user: 0,
        nsfw: false,
      },
      {
        id: "816502046693785601",
        last_message_id: "1021841685262651462",
        type: 0,
        name: "question-mark",
        position: 3,
        flags: 0,
        parent_id: null,
        topic: null,
        guild_id: "229093679103606785",
        permission_overwrites: [
          {
            id: "229093679103606785",
            type: 0,
            allow: "0",
            deny: "268436496",
          },
          {
            id: "630225571795959821",
            type: 0,
            allow: "1024",
            deny: "0",
          },
          {
            id: "630115776560627725",
            type: 0,
            allow: "1024",
            deny: "0",
          },
          {
            id: "341786383721168909",
            type: 0,
            allow: "1024",
            deny: "0",
          },
        ],
        last_pin_timestamp: "2021-07-16T02:38:01+00:00",
        rate_limit_per_user: 0,
        nsfw: true,
      },
    ];

    it("checks permissions correctly for owner user", () => {
      channels.forEach((channel) => {
        expect(
          hasPermissions(
            member,
            { ...guild, owner_id: member.user.id },
            channel
          )
        ).toEqual(true);
      });
    });

    it("checks permissions correctly for admin user", () => {
      for (let channel of channels) {
        expect(
          hasPermissions(
            { ...member, roles: [adminRole, somePermissionsRole] },
            guild,
            channel
          )
        ).toEqual(true);
      }
    });

    it("checks permissions correctly for user with some permissions", () => {
      const shouldHavePermissions = [0, 1, 3, 5, 6, 7, 9];
      channels.forEach((channel, index) => {
        expect(
          hasPermissions(
            { ...member, roles: [somePermissionsRole] },
            guild,
            channel
          )
        ).toEqual(shouldHavePermissions.includes(index));
      });
    });

    it("checks permissions correctly for user without roles", () => {
      const shouldHavePermissions = [0, 1, 3, 6, 7, 9];
      channels.forEach((channel, index) => {
        expect(hasPermissions(member, guild, channel)).toEqual(
          shouldHavePermissions.includes(index)
        );
      });
    });
  });
});
